<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AR English Eat</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Excel Export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { background:#0f172a; }
.btn { @apply px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 transition; }
</style>
</head>

<body class="text-white min-h-screen flex items-center justify-center">

<!-- ================= LOGIN ================= -->
<div id="login" class="space-y-4 w-80">
    <h1 class="text-2xl font-bold text-center">AR English Eat</h1>
    <input id="stuNumber" class="w-full px-4 py-2 rounded text-black" placeholder="เลขที่"/>
    <input id="stuName" class="w-full px-4 py-2 rounded text-black" placeholder="ชื่อ-สกุล"/>
    <button onclick="startGame()" class="w-full btn">เริ่มเกม</button>
    <button onclick="adminLogin()" class="w-full bg-gray-700 py-2 rounded-xl">Admin</button>
</div>

<!-- ================= GAME ================= -->
<div id="game" class="hidden space-y-6 text-center">
    <h2 class="text-xl font-bold">สะกดคำให้ถูกต้อง</h2>
    <div class="text-5xl font-bold text-yellow-300" id="word"></div>
    <input id="answer" class="px-4 py-2 rounded text-black"/>
    <button onclick="checkAnswer()" class="btn">ยืนยัน</button>
    <p id="feedback"></p>
    <p class="text-green-400 font-bold">คะแนน: <span id="score">0</span></p>
    <button onclick="finishGame()" class="bg-red-600 px-4 py-2 rounded-xl">จบเกม</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="admin" class="hidden w-full max-w-4xl">
    <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>

    <table class="w-full text-sm border border-gray-700 rounded">
        <thead class="bg-gray-800">
            <tr>
                <th class="p-2">เวลา</th>
                <th class="p-2">เลขที่</th>
                <th class="p-2">ชื่อ</th>
                <th class="p-2">คะแนน</th>
            </tr>
        </thead>
        <tbody id="admin-table-body"></tbody>
    </table>

    <div class="flex gap-4 mt-4">
        <button onclick="exportAllToExcel()" class="btn">Export Excel</button>
        <button onclick="location.reload()" class="bg-gray-600 px-4 py-2 rounded-xl">ออก</button>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- GAME DATA ---------- */
const words = ["apple","banana","cat","dog","egg","fish"];
let currentWord = "";
let state = {
    score: 0,
    history: [],
    user: { name:"", number:"" }
};

/* ---------- LOGIN ---------- */
function startGame(){
    state.user.name = stuName.value;
    state.user.number = stuNumber.value;
    if(!state.user.name || !state.user.number){
        alert("กรอกข้อมูลให้ครบ");
        return;
    }
    login.classList.add("hidden");
    game.classList.remove("hidden");
    nextWord();
}

function adminLogin(){
    const pin = prompt("ใส่ PIN Admin");
    if(pin === "1234"){
        login.classList.add("hidden");
        admin.classList.remove("hidden");
        loadAdminData();
    } else {
        alert("PIN ไม่ถูกต้อง");
    }
}

/* ---------- GAME ---------- */
function nextWord(){
    currentWord = words[Math.floor(Math.random()*words.length)];
    word.innerText = currentWord;
    answer.value = "";
    feedback.innerText = "";
}

function checkAnswer(){
    if(answer.value.toLowerCase() === currentWord){
        state.score += 10;
        feedback.innerText = "✅ ถูกต้อง";
    } else {
        feedback.innerText = "❌ ผิด";
    }
    score.innerText = state.score;
    nextWord();
}

function finishGame(){
    saveScore();
    alert("บันทึกคะแนนเรียบร้อย");
    location.reload();
}

/* ---------- LOCAL STORAGE ---------- */
function saveScore(){
    const data = JSON.parse(localStorage.getItem("AR_SCORES") || "[]");
    data.push({
        name: state.user.name,
        number: state.user.number,
        score: state.score,
        dateString: new Date().toLocaleString()
    });
    localStorage.setItem("AR_SCORES", JSON.stringify(data));
}

function loadAdminData(){
    const data = JSON.parse(localStorage.getItem("AR_SCORES") || "[]");
    const tbody = document.getElementById("admin-table-body");

    if(!data.length){
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">ไม่มีข้อมูล</td></tr>`;
        return;
    }

    window.adminDataCache = data;

    tbody.innerHTML = data.map(d=>`
        <tr class="border-t border-gray-700">
            <td class="p-2">${d.dateString}</td>
            <td class="p-2">${d.number}</td>
            <td class="p-2">${d.name}</td>
            <td class="p-2 text-green-400 font-bold">${d.score}</td>
        </tr>
    `).join("");
}

function exportAllToExcel(){
    if(!window.adminDataCache) return;
    const rows = [["Time","Number","Name","Score"]];
    adminDataCache.forEach(d=>{
        rows.push([d.dateString,d.number,d.name,d.score]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Scores");
    XLSX.writeFile(wb,"AR_English_Eat.xlsx");
}
</script>

</body>
</html>
